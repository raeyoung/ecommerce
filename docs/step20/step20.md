## 가상 장애 대응 방안에 관한 보고서

---
## 목차
[1. 개요](#1.-개요)<br>
[2. 잠재적 장애 시나리오 및 대응 방안](#2.-잠재적-장애-시나리오-및-대응-방안)<br>
&emsp;&emsp;&emsp;&emsp;[2.1 데이터베이스 과부하](#2.1-데이터베이스-과부하)<br>
&emsp;&emsp;&emsp;&emsp;[2.2 캐시 서버 장애](#2.2-캐시-서버-장애)<br>
&emsp;&emsp;&emsp;&emsp;[2.3 선착순 쿠폰 발급 시스템 오작동](#2.3-선착순-쿠폰-발급-시스템-오작동)<br>
&emsp;&emsp;&emsp;&emsp;[2.4 연속적인 결제 API 호출](#2.4-연속적인-결제-API-호출)<br>
[3. 결론 및 회고](#3.-결론-및-회고)<br>
&emsp;&emsp;&emsp;&emsp;[3.1 결론](#3.1-결론)<br>
&emsp;&emsp;&emsp;&emsp;[3.2 회고](#3.2-회고)<br>
---

### 1. 개요
e-commerce 서비스의 부하 테스트 결과를 바탕으로, 발생 가능한 다양한 장애 상황과 그에 대한 대응 방안을 상세히 기술합니다. <br>
시스템의 안정성과 가용성을 유지하기 위해 각 시나리오별 구체적인 대응 절차를 제시하며, 
실제 상황에서 신속하고 효과적으로 대처할 수 있도록 가이드라인을 제공합니다.

### 2. 잠재적 장애 시나리오 및 대응 방안
#### 2.1 데이터베이스 과부하

#### 시나리오
- 선착순 쿠폰 발급으로 인해 대규모 할인 이벤트 중 동시 접속자가 급증하여 데이터베이스의 CPU 사용률이 95%를 초과하고, 쿼리 응답 시간이 500ms 이상으로 증가하는 상황입니다. 
- 일부 사용자는 상품 페이지에 접속할 수 없으며, 전체 시스템 응답 속도가 저하됩니다.
<br><br>
- 징후 
  - CPU 사용률 95% 이상 지속 
  - 쿼리 응답 시간 500ms 이상 
  - DB 연결 타임아웃 오류 다수 발생 
  - 고객센터에 접속 장애 관련 문의 증가

#### 대응 방안
1. **즉시 조치 (30분 이내)**
   - 읽기 전용 쿼리를 복제본으로 리다이렉션합니다.
     - 조치 방법: 애플리케이션의 데이터베이스 연결 설정을 동적으로 변경하여 읽기 쿼리를 복제본으로 전송한다.
     - 조치 효과: 주 데이터베이스 서버의 부하를 약 40-50% 감소시킬 것으로 예상된다.

2. **단기 조치 (6시간 이내)**
   - 데이터베이스 서버의 CPU 및 메모리 리소스를 증설합니다.  
     - 조치 방법: 클라우드 환경의 경우 인스턴스 타입을 변경하고, 물리 서버의 경우 긴급 하드웨어를 증설합니다.
     - 조치 효과: 처리 속도를 높여 서비스 안정성을 유지합니다.
   - 인덱스를 재구성하고 쿼리를 최적화합니다.
     - 조치 방법: 실행 계획을 분석하여 쿼리를 최적화합니다.
     - 조치 효과: 주요 쿼리의 실행 시간을 30% 이상 단축할 수 있습니다.
   - 데이터베이스 캐싱을 강화합니다.
     - 조치 방법: 애플리케이션 레벨에서 Redis 등을 활용한 결과 캐싱을 구현합니다.
     - 조치 효과: 반복적인 읽기 쿼리의 데이터베이스 부하 50% 감소할 수 있습니다.

3. **장기 조치 (1-2주 이내)**
   - 데이터베이스 샤딩 적용합니다.
     - 조치 방법: 사용자 ID나 결재 ID를 기준으로 데이터를 여러 데이터베이스에 분산 저장합니다.
     - 조치 효과: 단일 데이터베이스 서버의 부하를 분산하여 전체 처리량 3배 이상 증가할 수 있습니다. 
   - 읽기/쓰기 분리 아키텍처를 도입합니다.
     - 조치 방법: 쓰기 작업은 마스터 DB로, 읽기 작업은 다수의 읽기 전용 복제본으로 분산합니다.
     - 조치 효과: 읽기 작업의 처리량 5배 이상 증가, 쓰기 작업의 안정성 확보합니다.

#### 2.2 캐시 서버 장애
#### 시나리오
- Redis 캐시 서버 장애로 인해 API 응답 시간이 2,000ms로 증가하고 데이터베이스 부하가 급증하는 상황입니다.
<br><br>
- 징후
  - Redis 연결 오류 증가 
  - API 응답 시간 2000ms 이상 
  - DB 부하 200% 이상 증가 
  - 캐시 히트율 0%

#### 대응 방안
1. **즉시 조치 (15분 이내)**
    - 백업 캐시 서버로 자동 전환합니다.
        - 조치 방법: DNS 또는 로드 밸런서 설정을 통해 트래픽을 백업 캐시 서버로 리다이렉트합다.
        - 조치 효과: 캐시 서비스 복구 속도를 단축하고 데이터베이스 부하를 줄입니다.
    - 애플리케이션의 캐시 우회 로직을 활성화합니다.
        - 조치 방법: 미리 준비된 환경 변수 또는 설정을 통해 캐시 없이 직접 DB 조회하도록 전환합니다.
        - 조치 효과: API 응답 시간을 1000ms 이내로 단축합니다.
    - 사용자에게 일시적인 서비스 지연을 안내합니다.
        - 조치 방법: 웹사이트 배너 및 푸시 알림을 통해 현재 상황과 예상 복구 시간을 안내합니다.
        - 조치 효과: 고객 불만을 최소화하고 불필요한 재시도를 방지합니다.

2. **단기 조치 (2시간 이내):**
    - Redis 서버를 재시작하고 상태를 점검합니다.
        - 조치 방법: 서버 로그 분석 후 Redis 프로세스를 재시작하고, 메모리 및 연결 상태를 점검합니다.
        - 조치 효과: 서비스 복구 시간을 단축하고 장애 원인을 분석할 수 있습니다.
    - 주요 데이터에 대한 캐시 데이터를 재구축합니다.
        - 조치 방법: 주요 데이터(상품 정보, 결재 상태 등)에 대한 캐시 워밍업 스크립트를 실행합니다.
        - 조치 효과: 30분 이내 캐시 히트율을 90% 이상 회복할 수 있습니다.

3. **장기 조치 (1주일 이내):**
    - Redis 클러스터를 구성하여 고가용성을 확보합니다.
        - 조치 방법: 최소 3대의 마스터 노드와 각각의 슬레이브 노드로 클러스터를 구성합니다.
        - 조치 효과: 단일 노드 장애 시에도 서비스 지속 운영이 가능합니다.
    - 캐시 데이터 분산 저장 전략을 수립합니다.
        - 조치 방법: 데이터 특성에 따라 여러 Redis 인스턴스에 분산 저장하는 로직을 구현합니다.
        - 조치 효과: 부하를 분산하고 전체 처리량을 3배 이상 증가시킵니다.

#### 2.3 선착순 쿠폰 발급 시스템 오작동

#### 시나리오
- Redis로 구현한 선착순 쿠폰 발급 시스템에 버그가 발생하여, 일부 사용자가 쿠폰을 중복 발급받거나 발급 순서가 엉키는 문제가 발생합니다.
- 이로 인해 쿠폰이 제대로 발급되지 않거나, 쿠폰발급 대상자가 아닌 쿠폰 발급 사용자가 늘어나며, 고객 불만이 급증합니다.
- 일부 사용자들은 쿠폰 발급 시스템을 우회하거나, 비정상적인 방법으로 쿠폰을 얻는 방법을 공유하기 시작하여 보안 문제가 발생하는 시나리오입니다.

- 징후
  - 고객 지원 센터로의 문의가 평소의 10배 수준으로 폭주합니다. 
  - 쿠폰 발급 시스템 로그에서 비정상적인 패턴이 발견됩니다. (쿠폰 중복 발급 등) 
  - 실시간 모니터링에서 쿠폰 발급 실패율이 정상치의 5배 이상으로 증가합니다.

#### 대응 방안
- **즉시 조치 (30분 이내)**
  - 쿠폰 발급 API를 일시적으로 정지하고, 대기 상태로 전환합니다.
    - 조치 방법: 발급 대기 페이지로 사용자 유도 및 쿠폰 발급 서비스 일시 중지합니다. 
    - 조치 효과: 추가적인 쿠폰 중복 발급 및 오류 발생 방지, 상황을 안정화시킬 수 있습니다.
  - 사용자에게 현재 상황과 쿠폰 발급 재개 시점을 안내합니다.
    - 조치 방법: 팝업 메시지, SMS, 이메일을 통해 예고합니다.
    - 조치 효과: 사용자 불안 감소 및 시스템 재접속 시도 방지할 수 있습니다.
- **단기 조치 (4시간 이내)**
  - 버그 원인을 파악하고 긴급 패치를 적용합니다.
    - 조치 방법: Redis 캐시 및 발급 로직 점검 후 핫픽스 배포합니다.
    - 조치 효과: 근본적인 문제 해결 및 쿠폰 발급 정상화합니다.
  - 영향을 받은 사용자들에게 보상 정책을 수립하고 안내합니다.
    - 조치 방법: 쿠폰 재발급, 할인 쿠폰 제공 등의 보상책을 마련합니다.
    - 조치 효과: 고객 신뢰 회복 및 부정적 여론 완화합니다.
  - 쿠폰 발급 데이터를 복구하고 정상화합니다.
    - 조치 방법: 쿠폰 발급 로그 및 Redis 데이터를 기반으로 공정하게 복원합니다.
    - 조치 효과: 공정성 논란 해소 및 시스템 신뢰도 회복합니다.
- **장기 조치 (1-2주 이내)**
  - 스트레스 테스트 및 시뮬레이션을 강화합니다.
    - 조치 방법: 쿠폰 발급 시스템에 대해 다양한 장애 시나리오를 적용한 정기적인 모의훈련을 실시합니다.
    - 조치 효과: 유사 상황 재발 방지 및 대응 능력 향상시킬 수 있습니다.
  - 실시간 모니터링 및 알림 시스템을 고도화합니다.
    - 조치 방법: Redis 모니터링 시스템 및 비정상적인 쿠폰 발급 패턴 탐지 시스템을 도입합니다.
    - 조치 효과: 장애 조기 감지 및 선제적 대응 체계 구축합니다.

#### 2.4 연속적인 결제 API 호출
#### 시나리오 
- 고객이 쿠폰 발급 후 결제를 시도하는 과정에서, 네트워크 지연이나 사용자 실수로 인해 결제 API를 여러 번 호출하게 됩니다. 
- 또는, 악의적인 사용자가 결제 시스템에 대량의 요청을 보내 시스템에 과부하를 유발하고, 이를 통해 여러 번 결제를 시도하여 문제가 발생하는 시나리오입니다.

- 징후
  - 결제 API 서버에 비정상적인 요청이 반복적으로 발생합니다.
  - 결제 완료 메시지가 중복으로 전송되거나, 일부 사용자 계정에 대해 결제 처리 실패가 반복된됩니다.
  - 실시간 모니터링에서 결제 API의 응답 시간이 비정상적으로 늘어나고, 오류 발생률이 급증합니다.

#### 대응 방안
- **즉시 조치 (30분 이내)**
  - 결제 API의 연속 호출을 감지하고, 동일 결제 요청에 대한 중복 처리를 막습니다.
    - 조치 방법: 결제 요청의 고유 트랜잭션 ID를 생성하여, 동일한 ID로 연속 호출을 차단합니다.
    - 조치 효과: 중복 결제를 방지하고, 시스템의 일관성을 유지합니다.
  - 결제 처리 시스템에서 과도한 호출을 제한하는 rate-limiting 정책을 즉시 적용합니다.
    - 조치 방법: 연속된 결제 요청에 대해 일정 시간 내에 여러 번 요청하면 차단하거나 대기시간을 늘립니다.
    - 조치 효과: 과부하를 방지하고, 시스템 자원을 효율적으로 관리합니다.
  - 시스템 과부하를 막기 위해 결제 API를 임시로 비활성화하고, 결제 처리 대기 페이지로 사용자 안내를 전환합니다.
    - 조치 방법: 결제 API를 일시적으로 중지하고, 대기 상태로 사용자 유도 및 안내 메시지를 제공합니다.
    - 조치 효과: 추가적인 시스템 오류를 방지하고, 사용자에게 상황을 명확히 안내하여 불안감을 줄입니다.
- **단기 조치 (4시간 이내)**
  - 결제 시스템의 로깅과 모니터링을 강화하여 중복 결제 요청 및 오류 패턴을 정확히 추적합니다.
    - 조치 방법: 중복 결제 방지를 위한 로직을 강화하고, 이상 트랜잭션을 탐지하여 관리자에게 알림을 보냅니다.
    - 조치 효과: 문제의 원인을 신속하게 파악하고, 재발 방지를 위한 근본적인 해결책을 마련합니다.
  - 결제 시스템에 대한 예외 처리를 추가하여, 네트워크 오류나 사용자 실수로 인한 반복 호출을 방지합니다.
    - 조치 방법: 트랜잭션 실패 시 자동 재시도 제한을 두거나, 결제 요청의 상태를 실시간으로 갱신하여 사용자가 반복 호출을 하지 않도록 합니다.
  - 조치 효과: 사용자 실수로 인한 중복 결제를 예방하고, 시스템의 안정성을 유지합니다.
- **장기 조치 (1-2주 이내)**
  - 결제 시스템의 안정성을 높이기 위한 추가적인 부하 테스트와 시나리오 테스트를 강화합니다.
    - 조치 방법: 연속적인 결제 요청을 포함한 다양한 부하 테스트 시나리오를 통해 시스템의 취약점을 찾아냅니다.
    - 조치 효과: 시스템의 취약점을 사전에 파악하고, 장애가 발생하기 전에 개선 작업을 진행합니다.

### 3. 결론 및 회고
#### 3.1 결론
- 본 보고서에서는 e-commerce 시스템의 부하 테스트 결과를 바탕으로 발생할 수 있는 다양한 장애 시나리오와 그에 대한 대응 방안을 상세히 제시했습니다.
- 데이터베이스 과부하 및 캐시 서버 장애, 선착순 쿠폰 발급 시스템 오작동과 연속적인 결제 API 호출 시나리오에 대해 구체적이고 효과적인 대응 방안을 준비하여, 장애 발생 시 신속하게 문제를 해결할 수 있는 체계를 구축했습니다. <br>각 대응 방안은 실시간으로 시스템을 안정화시키고, 사용자 불편을 최소화하며, 서비스의 신뢰를 회복할 수 있는 방법을 제공합니다.
- 또한, 장기 조치를 통해 시스템의 취약점을 개선하고, 유사 장애의 재발을 방지하기 위한 지속적인 테스트와 모니터링 시스템 강화를 통해 이커머스 시스템의 전반적인 안정성을 높였습니다.

#### 3.2 회고
보고서를 작성하면서 예상되는 다양한 장애 시나리오에 대해 체계적인 대응 방안을 세우는 것이 얼마나 중요한지 깨달았습니다. 
각 장애 유형에 대해 즉시, 단기, 장기 조치를 구체적으로 작성함으로써 시스템의 안정성을 고민해볼 수 있었습니다. <br>
장애가 발생하기 전에 자동화된 모니터링 시스템을 도입해 실시간으로 장애 징후를 조기에 탐지하고 대응할 수 있는 시스템 구축에 대한 필요성을 느꼈으며, 
**대규모 트래픽 처리**와 **다양한 유형의 사용자 요청**에 대비한 **캐시 전략 강화**도 필요하다고 생각합니다. <br>
해당 내용을 바탕으로 앞으로도 현업에서 장애 예방 및 빠른 대응 체계를 강화하여 보다 나은 서비스를 제공할 수 있도록 개선해야할 필요성을 느꼈습니다.
